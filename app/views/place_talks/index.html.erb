<head>
<meta name="viewport" content="initial-scale=1.0,user-scalable=no">
<script type="text/javascript" charset="utf-8" src="https://map.yahooapis.jp/js/V1/jsapi?appid=dj00aiZpPUxLVk9XdzYzandraCZzPWNvbnN1bWVyc2VjcmV0Jng9YWU-"></script>
</head>



<div id="map" style="width:500px; height:400px"></div>
<div class="sub-menu">
<h3>中心点の緯度経度</h3>

緯度：<input id="lat" type="text" size="25" value="35.665627">  経度：<input id="lng" type="text" size="25" value="139.730738">
</div>

<style>
.sub-menu {
    margin:4px;
    padding:4px;
    border:1px solid;
}
.sub-menu h3 {
    font-size:14px;
    margin:2px;
    padding:2px;
}
</style>

<script type="text/javascript">
//mapを新しく作成
window.onload = function(){
    var ymap = new Y.Map("map", {
        configure : {
            doubleClickZoom : true,//ダブルクリックでズーム
            scrollWheelZoom : true,
            singleClickPan : true,
            dragging : true,
            continuousZoom : true
        }
    });

    ymap.drawMap(new Y.LatLng(35.66572, 139.73100), 17, Y.LayerSetId.NORMAL);//地図を表示

    var control = new Y.SearchControl();//検索フォームを追加
    ymap.addControl(control);

    var control = new Y.SliderZoomControlVertical();//ズームスライドバーを追加
    ymap.addControl(control);

    ymap.bind("moveend", function(){onMoved();});//地図移動した時に、移動後の中心地の緯度経度をとってる
    function onMoved(){
        latlng = ymap.getCenter();
        document.getElementById("lat").value = latlng.lat();
        document.getElementById("lng").value = latlng.lng();
  }

  //マーカーをクリックしたら呼び出される
  var markerClicked = function(){
    // console.log("========")
      var ll = this.getLatLng();
      // alert(ll.toString());
       $.ajax({
          type:'POST', // リクエストのタイプはGETです
          url: '/search', // URLは/mealsを指定します。つまりmeals#indexのアクションをリクエストします
          data: {location: this.getLatLng().toString()}, // コントローラへフォームの値を送信します
          dataType: 'json' // データの型はjsonで指定します
        }).done(function (data){
            let comment = data.location.comment
            $("#comment").text(comment)
             // console.log(comment)
        }).fail(function (data) {
           //通信失敗
    　　　　alert('通信に失敗しました。');  
    });
  }


  $(document).on("ajax:success", ".submit", function(e) {
    // $('.comment').html(e.detail[2]["response"]);
    // console.log(e)
    let response = e.detail[2]["response"]
    // console.log(response)
    let locations = JSON.parse(response).location
    for (var i = 0; i < locations.length; i++) {
      let lat = Number(locations[i].latitude)
      let lon = Number(locations[i].longitude)
      var marker = new Y.Marker(new Y.LatLng(lat,lon));
      //markerにクリックイベントをつける（bindする）
      marker.bind('click', markerClicked);
      ymap.addFeature(marker);
      //formの中を空にする
      // console.log("=============")
      $(".users_edit_account_edit").val("");
    }

    // console.log(e.detail[2]["response"])
  })
     // 地図をｸﾘｯｸしたのときマーカーを作成
    Y.Event.addListener(ymap, 'click', clickMap);
        function clickMap(latlng){
          // let mylating = new Y.LatLng (35.664551986452906,139.73157935714718)
          // console.log(mylating);

          // ymap.addFeature(new Y.Marker(mylating));
          $('#location').css('display', 'block')//下のフォームを表示
            var location = latlng
            // console.log(location);

          $('#longitude').val(location.Lon);
           //console.log(location.Lat);
          $('#latitude').val(location.Lat);
           //onsole.log(location.Lon);

           var latlng = new Y.LatLng(location.Lat, location.Lon);
           var request = { "latlng": latlng };

           var geocoder = new Y.GeoCoder();//Yahooのジオコーダー
           geocoder.execute(request , function( ydf ) {
              if ( ydf.features.length > 0 ) {
                var feature = ydf.features[0];
                alert(feature.property.Address);
                // console.log(feature);

                  $('#adress').val(feature.property.Address);
                  $('#prefecture').val(feature.property.AddressElement[0]);
                  // console.log(feature.property.AddressElement[0]);
            }
  } );
};
}

</script>
<!-- ここから追加フォームー -->
<div id="location" style="display: none">
  <p id="notice"><%= notice %></p>

<%= form_with model: Location.new, url: place_talks_path,method: :post,class:"submit" do |f| %>
  <h4>Comment</h4>
  <%= f.text_field :comment,class: "users_edit_account_edit"%>
  <%= f.hidden_field :longitude, :value => "longitude", :id => "longitude"  -%>
  <%= f.hidden_field :latitude, :value => "latitude", :id => "latitude" -%>
  <%= f.hidden_field :prefecture, :value => "prefecture", :id => "prefecture"  -%>
  <%= f.hidden_field :place_name, :value => "place_name", :id => "place_name"  -%>
  <%= f.hidden_field :adress, :value => "adress", :id => "adress"  -%>
  </span></p>

  <%= f.submit "作成"%>
<% end %>
</div>
<!-- ここまで追加フォームー -->
<%= link_to "地図を表示", place_talks_path,method: :post, remote: true, class:"submit" %>
<div id="comment"></div>

<h1>New place</h1>

<table>
    <% @place_talks.each do |pt| %>
      <tr>
        <td><%= pt.user.username %>さんが</td>
        <!-- ここから場所の名前の登録の有無によって分岐 -->
        <% if pt.place_name == nil %>
		<td><%= pt.adress %>に</td>
		<% else %>
		<td><%= pt.place_name %>に</td>
		<% end %>
		<!-- ここまで -->
        <td><%= pt.content.name %>を登録しました！</td>
        <td><%= link_to 'Show', place_talks_path(pt) %></td>
		<% if current_user != nil %>
		<% if pt.user.id == current_user.id %>
        <td><%= link_to 'Edit', edit_place_talk_path(pt.id) %></td>
		<% else %>
		<% end %>
		<% else %>
		<% end %>

      </tr>
    <% end %>
</table>




 <%= link_to image_tag('btn.png',:id => "funcBtn"), new_place_talk_path %>
 <style type="text/css">
#funcBtn{
position: fixed; bottom: 20px; right: 20px;
display: block;
width: 150px;
height: 150px;
border-radius: 50%;
transition:
opacity 0.2s ease-out 0s,
/*opacity 透明度を調整するもの ease-outは高速で動き出し、最後に減速します*/
bottom 0.2s ease-out 0s,
/*下に下がる速さ*/
right 0.2s ease-out 0s,
/*右に動く速さ*/
transform 0.2s ease-out 0s;
/*これがないとゆっくり動かない*/
}
#funcBtn.scroll{
	/*スクロールした時にこのCSSが効く*/
opacity: 0;
bottom: -50px;
right: 0px;
/*移動方向*/
/*-webkit-transform: rotate( 45deg );
-moz-transform: rotate( 45deg );*/
/*上に習い不要説ある*/
transform: rotate( 45deg );
}

.user_body{
  background-image: none;
}
</style>


